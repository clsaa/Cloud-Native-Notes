# 1.微服务监控

## 1.1.CAT

>CAT（Central Application Tracking）是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，基本接入了美团上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团各业务线提供系统的性能指标、健康状况、监控告警等。自2014年开源以来，除了美团之外，CAT还在携程、陆金所、猎聘网、找钢网等多家互联网公司生产环境应用

### 1.1.1.相关链接

* github: <http://github.com/dianping/cat>
* 官方博客: <https://tech.meituan.com/CAT_in_Depth_Java_Application_Monitoring.html>

### 1.1.2.主要优势与特点

* 生产环境长时间考验
* 多语言客户端
* 实时系统, 只有两秒左右的延迟
* 监控数据是全量统计


## 1.2.ZipKin


>由Twitter公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。

### 1.2.1.相关链接

官网: <https://zipkin.io/>

### 1.2.2.主要优势与特点

* 与SpringCloud可无缝集成,可快速完成部署
* 支持多种数据收集方式(HTTP/MQ),数据存储方式(内存/ES/RDB)
* 经历了生成环境考验(阿里早期和京东都使用ZipKin)
* 严格按照Google Dapper论文实现
* 多语言支持


## 1.3.pinpoint

>Pinpoint 是 Naver 开源的一款深度支持 Java 语言的服务追踪系统

### 1.3.1.相关链接

github: <http://naver.github.io/pinpoint/>

### 1.3.2.主要优势与特点

* 使用字节码注入方式, Only Java
* Pinpoint提供的功能比较丰富(字节码注入方式优势)
* 无侵入性(字节码注入方式优势)

## 1.4.skywalking


国人吴晟基于OpenTracking实现的开源项目skywalking>针对分布式系统的APM（应用性能监控）系统，特别针对微服务、cloud native和容器化(Docker, Kubernetes, Mesos)架构， 其核心是个分布式追踪系统。

### 1.4.1.相关链接

github: <https://github.com/apache/incubator-skywalking>

### 1.4.2.主要优势与特点

* 多语言支持
* 多类型探针(支持Pinpoint中的字节码增强也支持传统的埋点)
* 性能最优

## 比较

* 探针的性能消耗: Pinpoint>ZipKin>skywalking 参考<https://juejin.im/post/5a7a9e0af265da4e914b46f1>
* 代码的侵入性: ZipKin≈CAT>>Pinpoint≈Skywalking
* 可扩展性(水平扩展能力): ZipKin(http通信会对正常的访问造成影响，所以还是推荐基于mq异步方式通信)> Skywalking(单机和集群模式,collector与agent之间的通信使用了gRPC)?pinpoint(agent通过thrift通信框架，发送链路信息到collector)
* 平台支持:ZipKin≈CAT>>Pinpoint
* 调用链精度:Pinpoint≈Skywalking>>ZipKin

![image](http://cloud-computing-notes-img-bed-1252032169.cossh.myqcloud.com/2018-10-21-122429.png)
![image](http://cloud-computing-notes-img-bed-1252032169.cossh.myqcloud.com/2018-10-21-122514.png)
![image](http://cloud-computing-notes-img-bed-1252032169.cossh.myqcloud.com/2018-10-21-125502.png)


![image](http://cloud-computing-notes-img-bed-1252032169.cossh.myqcloud.com/2018-10-21-113934.png)

## 其他

### 字节码vsAPI调用

Pinpoint 实现了基于字节码注入的 Java Agent 探针，而 Zipkin 的 Brave 框架仅仅提供了应用层面的 API，但是细想问题远不那么简单。字节码注入是一种简单粗暴的解决方案，理论上来说无论任何方法调用，都可以通过注入代码的方式实现拦截，也就是说没有实现不了的，只有不会实现的。但 Brave 则不同，其提供的应用层面的 API 还需要框架底层驱动的支持，才能实现拦截。比如，MySQL 的 JDBC 驱动，就提供有注入 interceptor 的方法，因此只需要实现 StatementInterceptor 接口，并在 Connection String 中进行配置，就可以很简单的实现相关拦截；而与此相对的，低版本的 MongoDB 的驱动或者是 Spring Data MongoDB 的实现就没有如此接口，想要实现拦截查询语句的功能，就比较困难。

因此在这一点上，Brave 是硬伤，无论使用字节码注入多么困难，但至少也是可以实现的，但是 Brave 却有无从下手的可能，而且是否可以注入，能够多大程度上注入，更多的取决于框架的 API 而不是自身的能力。



### 成本

经过简单阅读 Pinpoint 和 Brave 插件的代码，可以发现两者的实现难度有天壤之别。在都没有任何开发文档支撑的前提下，Brave 比 Pinpoint 更容易上手。Brave 的代码量很少，核心功能都集中在 brave-core 这个模块下，一个中等水平的开发人员，可以在一天之内读懂其内容，并且能对 API 的结构有非常清晰的认识。

Pinpoint 的代码封装也是非常好的，尤其是针对字节码注入的上层 API 的封装非常出色，但是这依然要求阅读人员对字节码注入多少有一些了解，虽然其用于注入代码的核心 API 并不多，但要想了解透彻，恐怕还得深入 Agent 的相关代码，比如很难一目了然的理解 addInterceptor 和 addScopedInterceptor 的区别，而这两个方法就是位于 Agent 的有关类型中。

因为 Brave 的注入需要依赖底层框架提供相关接口，因此并不需要对框架有一个全面的了解，只需要知道能在什么地方注入，能够在注入的时候取得什么数据就可以了。就像上面的例子，我们根本不需要知道 MySQL 的 JDBC Driver 是如何实现的也可以做到拦截 SQL 的能力。但是 Pinpoint 就不然，因为 Pinpoint 几乎可以在任何地方注入任何代码，这需要开发人员对所需注入的库的代码实现有非常深入的了解，通过查看其 MySQL 和 Http Client 插件的实现就可以洞察这一点，当然这也从另外一个层面说明 Pinpoint 的能力确实可以非常强大，而且其默认实现的很多插件已经做到了非常细粒度的拦截。
